pytest
============================================================

* サードパーティライブラリ https://pypi.org/project/pytest/
* :command:`pip install pytest`

.. ずっと昔はpy.test

pytestで書くテスト
============================================================

1. テストコードのファイルを作る
2. テストコードとして、関数を書く
3. assert文

pytestの規則に従ったファイル
--------------------------------------------------

* ``test_`` で始まるPythonファイルを作成

.. 一般のプロジェクトでは tests ディレクトリの下

.. code-block::

    .
    ├── fizzbuzz.py
    └── test_fizzbuzz.py

pytestの規則に従った関数
--------------------------------------------------

* ``test_`` で始まる関数を書く

.. code-block:: python
    :caption: test_fizzbuzz.py

    def test_3の倍数のときはFizzを返す():
        ...

Pythonのassert文
--------------------------------------------------

* ``assert 式``
* 式が ``True`` と評価されるかを検証

https://docs.python.org/ja/3/reference/simple_stmts.html#the-assert-statement

assert文の例
--------------------------------------------------

.. code-block:: pycon

    >>> assert 1 == 1
    >>> assert 1 == 2
    Traceback (most recent call last):
      File "<stdin>", line 1, in <module>
    AssertionError

3Aで理解するpytest
--------------------------------------------------

.. code-block:: python
    :caption: test_fizzbuzz.py

    def test_3の倍数のときはFizzを返す():
        number = 3  # Arrange
        assert fizzbuzz(number) == "Fizz"  # Act & Assert

テスト実行 :command:`pytest -v`
--------------------------------------------------

.. code-block::

    .
    ├── fizzbuzz.py
    └── test_fizzbuzz.py

.. code-block::

    $ pytest -v
    ============================= test session starts ==============================
    
    collected 5 items

    ============================== 5 passed in 0.01s ===============================

failしたテスト（15でFizzを返した）
--------------------------------------------------

.. code-block::

    test_fizzbuzz.py::test_15の倍数のときはFizzBuzzを返す FAILED             [ 20%]

    =================================== FAILURES ===================================
    __________________________ test_15の倍数のときはFizzBuzzを返す ___________________________

        def test_15の倍数のときはFizzBuzzを返す():
    >       assert fizzbuzz(15) == "FizzBuzz"
    E       AssertionError: assert 'Fizz' == 'FizzBuzz'
    E         - FizzBuzz
    E         + Fizz

* assert文だが、diffが分かりやすい

pytestは **assert文を拡張**
--------------------------------------------------

* テストコードに使うのはassert文だけと **簡単**、かつ、fail下テストのdiffが **分かりやすい**
* 実はpytestがassert文を書き換えて、分かりやすいdiffを実現している（`assertion rewriting <https://docs.pytest.org/en/latest/how-to/writing_plugins.html#assertion-rewriting>`__）

pytestでdocstringの対話例も実行できる🏃‍♂️
--------------------------------------------------

* :command:`pytest --doctest-modules`
* https://docs.pytest.org/en/stable/how-to/doctest.html

パラメタ化テスト
============================================================

.. code-block:: python

    def test_3の倍数のときはFizzを返す():
        ...

3の倍数ならFizz
--------------------------------------------------

* 3
* 6
* 9

個別にテストの関数を書く？
--------------------------------------------------

.. code-block:: python

    def test_3の倍数のときはFizzを返す_3の場合():
        ...

    def test_3の倍数のときはFizzを返す_6の場合():
        ...

``@pytest.mark.parametrize`` を使おう
--------------------------------------------------

.. code-block:: python

    @pytest.mark.parametrize("number", [3, 6])
    def test_3の倍数のときはFizzを返す(number):
        assert fizzbuzz(number) == "Fizz"

1つの関数、複数のテストケース
--------------------------------------------------

.. code-block::

    $ pytest -v

    test_fizzbuzz.py::test_3の倍数のときはFizzを返す[3] PASSED               [ 40%]
    test_fizzbuzz.py::test_3の倍数のときはFizzを返す[6] PASSED               [ 60%]

個別に書いたのと同じ結果が得られる

モック
============================================================

TODO 見直し

部品ごとにテストする
--------------------------------------------------

* 全て通さないテストコード
* ある部品の呼び出し方を検証
* 部品自体は徹底的に検証

.. TODO 例を出す

モックを使って部品をテスト
--------------------------------------------------

* ある部品をモックにする
* モックは呼び出され方を覚えている -> 検証できる
* モックにした部品自体は、単体テストで徹底的に検証
