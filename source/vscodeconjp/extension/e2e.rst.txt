Part 2. æ‹¡å¼µã®E2Eãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã†
============================================================

ãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã„ï¼
--------------------------------------------------

* æ”¹é€ ãŒã†ã¾ãã„ãã€å…¬é–‹ãŒè¦‹ãˆã¦ããŸâœ¨
* IMOã€Œè‡ªåˆ†ä»¥å¤–ãŒä½¿ã†å¯èƒ½æ€§ãŒã‚ã‚‹ãªã‚‰ã€ãƒ†ã‚¹ãƒˆã‚’æ›¸ããŸã„ã€
* VS Codeã‚’æ“ä½œã™ã‚‹E2Eãƒ†ã‚¹ãƒˆï¼ˆEnd to Endï¼‰ã€ã©ã†æ›¸ãã‚“ã ï¼Ÿ

å®Ÿã¯ãƒ†ã‚¹ãƒˆã¯scaffoldã•ã‚Œã¦ã‚‹YO
--------------------------------------------------

* Yeomanã«ã‚ˆã‚Š :file:`src/test` ä»¥ä¸‹ã«ãƒ†ã‚¹ãƒˆã«ä½¿ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™
* :command:`npm run test` ã¾ãŸã¯ :command:`yarn test`

.. TODO ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ„ãƒªãƒ¼

ãƒ†ã‚¹ãƒˆã‚’ç¹°ã‚Šè¿”ã—å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«è¨­å®š
--------------------------------------------------

é–‹ç™ºç’°å¢ƒï¼ˆmacOSï¼‰ã§ã€ãƒ†ã‚¹ãƒˆã®2å›ã‚ãŒå®Ÿè¡Œã§ããªã‹ã£ãŸã®ã«å¯¾å‡¦

.. code-block:: ts
    :caption: src/test/runTest.ts
    :emphasize-lines: 7

    async function main() {
        // ... çœç•¥ ...
        await runTests(
            {
                extensionDevelopmentPath,
                extensionTestsPath,
                launchArgs: ['--user-data-dir', `${tmpdir()}`]
            });
        // ... çœç•¥ ...
    }

.. _typescript-language-featuresã®CodeLensã®E2E: https://github.com/microsoft/vscode/blob/1.74.3/extensions/typescript-language-features/src/test/smoke/referencesCodeLens.test.ts

ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’ç·¨é›†ã™ã‚‹æ‹¡å¼µã®ãƒ†ã‚¹ãƒˆï¼ˆIMOï¼‰
============================================================

* ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ãŸã¨ãã®CodeLensã®è¨­å®šï¼ˆå€‹æ•°ã‚„è¡Œï¼‰

  * ref: `typescript-language-featuresã®CodeLensã®E2E`_

* ãƒ¦ãƒ¼ã‚¶ãŒCodeLensã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã®ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ãŸã¨ãã®CodeLensã®è¨­å®šã‚’ãƒ†ã‚¹ãƒˆ
============================================================

* ãƒ†ã‚¹ãƒˆã«ä½¿ã†ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ**ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£**ï¼‰
* ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§CodeLensã‚’å–å¾—ã™ã‚‹

ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®è¨­å®š
--------------------------------------------------

* ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’é…ç½®
* ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®šï¼ˆ:file:`src/test/runTest.ts`ï¼‰

ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
--------------------------------------------------

.. code-block:: markdown
    :lineno-start: 0
    :caption: test-fixtures/markdown/example.md

    # Test of tokimeki-editing

    ## ãƒ†ã‚¹ãƒˆæ­©å¤¢

    æ­©å¤¢ã®è¡Œã«emojiã‚’è¿½åŠ ã§ãã‚‹

    ã“ã®è¡Œã«ã¯ä½•ã‚‚ã—ã¾ã›ã‚“

.. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ„ãƒªãƒ¼ãŒã‚ã£ã¦ã‚‚ã„ã„ã‹ã‚‚

ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®š
--------------------------------------------------

.. code-block:: ts
    :caption: src/test/runTest.ts
    :emphasize-lines: 3,8

    async function main() {
        // ... çœç•¥ ...
        const testWorkspace = path.resolve(__dirname, '../../test-fixtures');
        await runTests(
            {
                extensionDevelopmentPath,
                extensionTestsPath,
                launchArgs: [testWorkspace, '--user-data-dir', `${tmpdir()}`]
            });
        // ... çœç•¥ ...
    }

.. TODO ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«ã‚ã‚‹ã¨ç¤ºã—ãŸã„
    https://github.com/ftnext/vscode-tokimeki-editing/blob/v0.0.2/src/test/suite/extension.test.ts

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
------------------------------------------------------------

.. code-block:: ts
    :caption: src/test/suite/extension.test.ts

    const testFileLocation = '/markdown/example.md';

    suite('Extension Test Suite', () => {
        let fileUri: vscode.Uri;
        let editor: vscode.TextEditor;
        
        setup(async () => {
            fileUri = vscode.Uri.file(vscode.workspace.workspaceFolders![0].uri.fsPath + testFileLocation);
            const document = await vscode.workspace.openTextDocument(fileUri);
            editor = await vscode.window.showTextDocument(document);
        });
    });

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§CodeLensã‚’å–å¾—ã™ã‚‹
--------------------------------------------------

.. code-block:: ts

    vscode.commands.executeCommand<readonly vscode.CodeLens[]>('vscode.executeCodeLensProvider', fileUri, 100);

ref: `typescript-language-featuresã®CodeLensã®E2E`_

CodeLensã®è¨­å®šã‚’ãƒ†ã‚¹ãƒˆ
--------------------------------------------------

.. code-block:: ts
    :caption: src/test/suite/extension.test.ts

    const codeLenses = await vscode.commands.executeCommand<readonly vscode.CodeLens[]>('vscode.executeCodeLensProvider', fileUri, 100);

    // ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§CodeLensã¯ã„ãã¤è¨­å®šã•ã‚Œã‚‹ã‹ - 2å€‹
    assert.strictEqual(codeLenses?.length, 2);
    // ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§CodeLensã¯ä½•è¡Œç›®ã«è¨­å®šã•ã‚Œã‚‹ã‹ - 2è¡Œç›®ã¨4è¡Œç›®ï¼ˆæ­©å¤¢ãŒã‚ã‚‹è¡Œï¼‰
    assert.strictEqual(codeLenses?.[0].range.start.line, 2);
    assert.strictEqual(codeLenses?.[1].range.start.line, 4);

ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã®ãƒ†ã‚¹ãƒˆ
============================================================

ãƒ¦ãƒ¼ã‚¶ãŒCodeLensã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã®ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹æ„å›³

ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
--------------------------------------------------

.. code-block:: ts
    :caption: src/test/suite/extension.test.ts

    test('Insert ğŸ€ after æ­©å¤¢', async () => {
        const COMMAND_NAME = "tokimeki-editing.addOshiEmoji";
        await sleep(1500);  // sleepã¯ãƒ¦ãƒ¼ã‚¶å®šç¾©é–¢æ•°ã§ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹ï¼ˆVS Codeã®Windowã®ãƒ­ãƒ¼ãƒ‰å¾…ã¡ã®æ„å›³ï¼‰
        // 4è¡Œç›®ã€Œæ­©å¤¢ã®è¡Œã«emojiã‚’è¿½åŠ ã§ãã‚‹ã€ã®ã€Œæ­©å¤¢ã€ã«CodeLensãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚
        // ã“ã®CodeLensãŒãƒ¦ãƒ¼ã‚¶ã«ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã¨åŒæ§˜ã®ã‚³ãƒãƒ³ãƒ‰å‘¼ã³å‡ºã—ï¼ˆã€Œæ­©å¤¢ã€ã®rangeã‚‚æ¸¡ã™ï¼‰
        await vscode.commands.executeCommand(COMMAND_NAME, new vscode.Range(new vscode.Position(4, 0), new vscode.Position(4, 2)));
        await sleep(500);

        const actual = editor.document.lineAt(4).text;
        assert.strictEqual(actual, 'æ­©å¤¢ğŸ€ã®è¡Œã«emojiã‚’è¿½åŠ ã§ãã‚‹');
    });

ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ãŒä¼¸ã³ãŸã“ã¨ã§ãƒ†ã‚¹ãƒˆãŒè½ã¡ãªã„ã‚ˆã†ã«ã™ã‚‹
------------------------------------------------------------

.. code-block:: ts
    :caption: src/test/suite/index.ts
    :emphasize-lines: 5

    export function run(): Promise<void> {
        const mocha = new Mocha({
            ui: 'tdd',
            color: true,
            timeout: 5000  // 2000msã‹ã‚‰ä¼¸ã°ã—ãŸï¼ˆ60000msã¾ã§ä¼¸ã°ã—ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ï¼‰
        });

        // ... çœç•¥ ...
    }

Mochaã®è¨­å®šã‚’å¤‰æ›´

ğŸŒ¯Part 2. æ‹¡å¼µã®E2Eãƒ†ã‚¹ãƒˆã‚’æ›¸ã“ã† ã¾ã¨ã‚
============================================================

* ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’ç·¨é›†ã§ãã‚‹CodeLensã‚’æä¾›ã™ã‚‹æ‹¡å¼µã«ã¤ã„ã¦ã€E2Eãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ãŸ

  * CodeLensã®è¨­å®šã‚’æ¤œè¨¼
  * ãƒ¦ãƒ¼ã‚¶ãŒCodeLensã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦æ¤œè¨¼

* runTestsã® ``launchArgs`` ãƒ»Mochaã®è¨­å®š

é–¢é€£ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ ğŸƒâ€â™‚ï¸
--------------------------------------------------

* `ç§ã¯ã€VS Codeæ‹¡å¼µã®E2Eã€æ›¸ã„ã¦ã¿ãŸã„ï¼ ã€œä»Šã¯ã“ã‚ŒãŒç²¾ä¸€æ¯ğŸ”°ã€ä¸­é–“å ±å‘Šç·¨ã€œ <https://nikkie-ftnext.hatenablog.com/entry/vscode-extension-codelens-e2e-beginner>`__
